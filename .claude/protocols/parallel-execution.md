# 並列実行プロトコル

## 概要

複数のサブエージェントを並列で実行するためのプロトコルです。

## 並列実行可能な条件

以下の条件をすべて満たす場合、タスクは並列実行可能：

1. **ファイル依存関係がない**: 異なるファイルを操作する
2. **データ依存関係がない**: 一方の出力が他方の入力にならない
3. **論理的依存関係がない**: 実行順序に制約がない

## タスク依存関係マトリクス

```
タスクA → タスクB  : Aの完了がBの前提条件（順次実行）
タスクA | タスクB  : 相互に独立（並列実行可能）
タスクA ⇄ タスクB  : 同一ファイルを操作（排他実行）
```

## 並列実行パターン

### パターン1: 機能別並列

```
[先駆者] src/features/auth.ts を実装
    |  並列実行
[先駆者] src/features/user.ts を実装
```

### パターン2: 役割別並列

```
[先駆者] src/api.ts を実装
    |  並列実行
[試験者] tests/utils.test.ts を作成（既存コードのテスト）
```

### パターン3: レビューと実装の並列

```
[師匠] src/auth.ts をレビュー
    |  並列実行
[先駆者] src/user.ts を実装（auth.tsに依存しない部分）
```

## 並列実行の制約

### 禁止パターン

1. **同一ファイルの同時編集**
   ```
   ❌ [先駆者] src/api.ts を実装
       |
   ❌ [師匠] src/api.ts をリファクタリング
   ```

2. **依存ファイルの同時変更**
   ```
   ❌ [先駆者] src/types.ts を変更
       |
   ❌ [先駆者] src/api.ts を実装（types.tsをimport）
   ```

## 状態管理

`.claude/state/plan.json` で以下を追跡：

- `activeAgents`: 現在実行中のエージェントとタスク
- `tasks`: 全タスクリストと状態
- `completedTasks`: 完了タスク

## エージェント間通信

サブエージェントは完了時に以下を報告：
1. 実施内容
2. 変更したファイル一覧
3. ロック解放の確認
4. 次のタスクへの引き継ぎ事項

## 段階的テスト・結合プロトコル（必須）

新機能開発・拡張開発時は、以下の段階的アプローチを**必ず**遵守すること。
各段階でテストを完了してから次の段階に進む。

### 基本原則

```
単機能テスト → 疎通テスト → 機能結合テスト → 全結合テスト
```

### 標準的な段階例（決済システム）

```
Phase 1: コア機能の単体テスト
├─ 認証なし・外部連携なしの基本CRUD
├─ モックデータでの動作確認
└─ ✓ 完了確認後、次のPhaseへ

Phase 2: 外部システムとの疎通テスト
├─ ブロックチェーンRPCとの接続確認
├─ 残高取得などの読み取り操作
└─ ✓ 完了確認後、次のPhaseへ

Phase 3: 外部連携機能の結合テスト
├─ 認証なしでのトランザクション送信
├─ 実際のテストネットでの動作確認
└─ ✓ 完了確認後、次のPhaseへ

Phase 4: 認証機能の単体テスト
├─ パスキー登録・認証フロー
├─ セッション管理
└─ ✓ 完了確認後、次のPhaseへ

Phase 5: 全機能結合テスト
├─ 認証 → 購入 → 決済 → アクセス付与
├─ E2Eシナリオテスト
└─ ✓ 完了確認後、リリース準備
```

### 段階間の移行ルール

1. **前段階のテスト成功が必須**: 前段階が完了するまで次段階に進まない
2. **ロールバック可能性の確保**: 各段階でスナップショット/チェックポイントを記録
3. **失敗時の切り分け**: 問題が発生した場合、どの段階で発生したか特定可能にする

### 並列実行との組み合わせ

段階的テストは並列実行と組み合わせ可能だが、以下を遵守：

```
✓ 同一Phase内の独立タスクは並列実行可
✓ 異なるPhase間は順次実行（依存関係あり）

例:
Phase 2内:
  [先駆者] ブロックチェーン疎通テスト | [試験者] Phase 1のテストコード整備
  （並列実行可能）

Phase 2 → Phase 3:
  Phase 2完了 → Phase 3開始（順次実行必須）
```

### 状態管理への記録

`.claude/state/plan.json` に各Phaseの状態を記録：

```json
{
  "integrationPhases": [
    {"phase": 1, "name": "コア機能単体テスト", "status": "completed"},
    {"phase": 2, "name": "外部疎通テスト", "status": "in_progress"},
    {"phase": 3, "name": "外部連携結合テスト", "status": "pending"}
  ]
}
```
