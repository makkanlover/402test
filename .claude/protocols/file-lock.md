# ファイルロックプロトコル

## 概要

並列実行時のファイル競合を防ぐためのプロトコルです。
すべてのサブエージェントはこのプロトコルに従ってファイル操作を行います。

## ロックファイル

`.claude/state/locks.json` にロック状態を管理します。

```json
{
  "locks": {
    "src/auth.ts": {
      "agent": "pioneer",
      "taskId": "task-001",
      "timestamp": "2025-01-01T00:00:00Z"
    }
  },
  "version": 1
}
```

## プロトコル手順

### 1. ファイル編集前（ロック取得）

ファイルを編集する前に必ず以下を実行：

1. `.claude/state/locks.json` を読み取る
2. 対象ファイルがロックされていないか確認
3. ロックされている場合：
   - 別のファイルを先に処理するか
   - ロック解除を待つ（他のタスクを進める）
4. ロックされていない場合：
   - ロックを取得（JSONを更新）
   - ファイルを編集

### 2. ファイル編集後（ロック解放）

編集完了後に必ず以下を実行：

1. `.claude/state/locks.json` を読み取る
2. 自分のロックを解放（該当エントリを削除）
3. JSONを保存

### 3. ロック取得の例

```
# ロック取得
locks.json の "src/auth.ts" に以下を追加:
{
  "agent": "pioneer",
  "taskId": "task-001",
  "timestamp": "現在時刻"
}
```

### 4. ロック解放の例

```
# ロック解放
locks.json から "src/auth.ts" エントリを削除
```

## 競合回避のベストプラクティス

1. **最小限のロック範囲**: 必要なファイルのみロック
2. **早期解放**: 編集完了後すぐにロック解放
3. **ロック確認の徹底**: 編集前に必ずロック状態を確認
4. **タイムアウト考慮**: 5分以上経過したロックは無効とみなせる

## 注意事項

- ロックは「編集」操作のみに適用
- 「読み取り」操作にはロック不要
- 新規ファイル作成時もロック取得推奨（同名ファイル競合防止）
