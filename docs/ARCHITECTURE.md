# アーキテクチャ

## システム構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        フロントエンド                            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │ トップ   │  │ 商品詳細 │  │ 認証     │  │ 履歴    │            │
│  │ ページ   │  │ ページ   │  │ ページ   │  │ ページ   │            │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        API層 (Next.js App Router)               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ /api/auth/*     │  │ /api/products/* │  │ /api/payments/* │ │
│  │ 認証API         │  │ 商品API         │  │ 決済API         │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        サービス層                                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐        │
│  │ auth.ts │  │products │  │payments │  │ blockchain  │        │
│  │ 認証     │  │ 商品     │  │ 決済     │  │ ブロック     │        │
│  │ サービス │  │ サービス │  │ サービス │  │ チェーン     │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│    SQLite       │  │ Avalanche Fuji  │  │  WebAuthn       │
│    (Prisma)     │  │   Testnet       │  │  Authenticator  │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

## 技術スタック

| レイヤー | 技術 |
|---------|------|
| フロントエンド | Next.js 16, React 19, Tailwind CSS 4 |
| API | Next.js App Router (Route Handlers) |
| データベース | SQLite + Prisma 6 |
| 認証 | SimpleWebAuthn (WebAuthn/Passkey) |
| ブロックチェーン | ethers.js 6, Avalanche Fuji Testnet |
| バリデーション | Zod 4 |

## ディレクトリ構成

```
src/
├── app/                    # Next.js App Router
│   ├── api/               # APIエンドポイント
│   │   ├── auth/          # 認証API
│   │   ├── payments/      # 決済API
│   │   ├── products/      # 商品API
│   │   └── seed/          # 初期データAPI
│   ├── auth/              # 認証ページ
│   ├── history/           # 購入履歴ページ
│   ├── products/          # 商品詳細ページ
│   ├── layout.tsx         # ルートレイアウト
│   └── page.tsx           # トップページ
├── config/                # 設定
│   └── chains.ts          # ブロックチェーン設定
├── lib/                   # サービス層
│   ├── auth.ts            # 認証サービス
│   ├── blockchain.ts      # ブロックチェーンサービス
│   ├── db.ts              # データベースクライアント
│   ├── payments.ts        # 決済サービス
│   └── products.ts        # 商品サービス
└── types/                 # 型定義
    └── index.ts           # 共通型
```

## データベーススキーマ

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │────<│   Passkey   │     │   Product   │
├─────────────┤     ├─────────────┤     ├─────────────┤
│ id          │     │ id          │     │ id          │
│ email       │     │ userId      │     │ name        │
│ name        │     │ credentialId│     │ description │
│ createdAt   │     │ publicKey   │     │ price       │
│ updatedAt   │     │ counter     │     │ currency    │
└─────────────┘     └─────────────┘     │ type        │
       │                                 └─────────────┘
       │                                        │
       ▼                                        │
┌─────────────┐     ┌─────────────┐            │
│   Session   │     │   Payment   │────────────┘
├─────────────┤     ├─────────────┤
│ id          │     │ id          │
│ userId      │     │ paymentId   │
│ token       │     │ userId      │
│ expiresAt   │     │ productId   │
└─────────────┘     │ amount      │
                    │ status      │
       │            │ txHash      │
       │            └─────────────┘
       │
       ▼
┌─────────────────┐
│  ProductAccess  │
├─────────────────┤
│ id              │
│ userId          │
│ productId       │
│ paymentId       │
│ grantedAt       │
└─────────────────┘
```

## 決済フロー

```
ユーザー              フロントエンド          API              ブロックチェーン
   │                      │                   │                      │
   │ 商品ページアクセス     │                   │                      │
   │─────────────────────>│                   │                      │
   │                      │ GET /api/products │                      │
   │                      │──────────────────>│                      │
   │                      │<──────────────────│                      │
   │<─────────────────────│                   │                      │
   │                      │                   │                      │
   │ 購入ボタンクリック     │                   │                      │
   │─────────────────────>│                   │                      │
   │                      │ POST /api/payments/initiate             │
   │                      │──────────────────>│                      │
   │                      │  HTTP 402         │                      │
   │                      │<──────────────────│                      │
   │                      │                   │                      │
   │                      │ POST /api/payments/process              │
   │                      │──────────────────>│                      │
   │                      │                   │ sendTransaction()    │
   │                      │                   │─────────────────────>│
   │                      │                   │<─────────────────────│
   │                      │                   │ grantAccess()        │
   │                      │<──────────────────│                      │
   │ アクセス権付与         │                   │                      │
   │<─────────────────────│                   │                      │
```
