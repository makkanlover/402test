# x402 プロトコル — 技術要件定義用まとめ

## 概要 / 背景
- x402 は HTTP ステータスコード **402 (Payment Required)** を活用した、インターネットネイティブな決済プロトコル。 :contentReference[oaicite:0]{index=0}  
- Coinbase によって設計され、AIエージェントや API 間の “機械対機械 (M2M)” 決済を簡素化することを目指している。 :contentReference[oaicite:1]{index=1}  
- ブロックチェーンに依存しない（Blockchain-agnostic）設計。さまざまなネットワーク／トークンを使える。 :contentReference[oaicite:2]{index=2}  
- 手数料が非常に小さい / ほぼゼロに近いモデルを目指している。 :contentReference[oaicite:3]{index=3}  
- 即時決済：ブロックチェーン上でのトランザクションを高速に扱い、支払いを “すぐに”確定させられる。 :contentReference[oaicite:4]{index=4}  

## アーキテクチャ / コンポーネント
- **Facilitator（ファシリテーター）** の概念を導入  
  - クライアントとマーチャント（サービス提供者）の間に、「支払いが正しく行われたかどうか」を検証する中間者として機能。 :contentReference[oaicite:5]{index=5}  
  - ファシリテーターは支払い証明 (payment proof) を監視し、確認が取れたらリソース (APIなど) を解放させる。 :contentReference[oaicite:6]{index=6}  
- HTTP レイヤー統合  
  - サーバー側では、HTTP リクエストに対して `402 Payment Required` を返す仕組みが基本。 :contentReference[oaicite:7]{index=7}  
  - 支払い情報は HTTP ヘッダー (例: `x-payment`) を通じてやり取りされる。 :contentReference[oaicite:8]{index=8}  
- ミドルウェア / ライブラリ  
  - リファレンス実装 (オープンソース) あり。Express.js や Next.js 向けサーバー ミドルウェアが提供されている。 :contentReference[oaicite:9]{index=9}  
  - クライアント向けライブラリ (ブラウザ / Node.js) も存在し、支払いの署名検証やトランザクション送信を支援。 :contentReference[oaicite:10]{index=10}  
- 暗号処理  
  - 支払い署名 (署名と検証) のための暗号ユーティリティが提供されており、ユーザーは支払いを“正しくやった”ことを証明できる。 :contentReference[oaicite:11]{index=11}  

## トークン / 経済モデル
- 取引・支払いはステーブルコイン (例: USDC) を使える構造が一般的。 :contentReference[oaicite:14]{index=14}  

## ユースケース / シナリオ

### AIエージェント・API決済
- **AI エージェント間支払い**: AI エージェントが API を呼び出すたびに自動で支払う。 :contentReference[oaicite:15]{index=15}  
- **コンテンツ / API マネタイズ**: API プロバイダーやデータ提供者が、ユーザー (もしくは他エージェント) から従量制で支払いを受ける。 :contentReference[oaicite:16]{index=16}  
- **クラウド / ストレージ支払い**: ストレージや計算リソースのマイクロ決済。 :contentReference[oaicite:17]{index=17}  
- **AI＋マルチシグウォレット**: 例として zCloak が、AI と人間の協働による x402 ベースのマルチシグウォレットを構築。 :contentReference[oaicite:18]{index=18}

### 一般消費者向け決済
- **オンラインショッピング**: ECサイトでの商品購入時に、暗号資産やステーブルコインで即時決済。従来のクレジットカード決済より手数料が低く、グローバルに利用可能。
- **店頭決済（POS）**: 実店舗でのQRコード決済やNFC決済に対応。ウォレットアプリから即座に支払いが完了し、マーチャントは手数料をほぼゼロで受け取れる。
- **サブスクリプション**: 月額・年額サービスの自動支払い。スマートコントラクトと連携して定期的な支払いを自動化。
- **デジタルコンテンツ購入**: 音楽、動画、電子書籍、NFTなどのデジタルコンテンツをマイクロペイメントで購入。従量課金やペイパービュー型のビジネスモデルに最適。
- **P2P送金**: 個人間での送金。国境を越えた送金でも手数料が安く、即時に完了。
- **チップ・投げ銭**: クリエイターやサービス提供者への少額支払い。SNSやライブ配信での投げ銭システムとして活用可能。  

## 技術的リスク・課題
- 払い戻し (Refund) が難しい：ブロックチェーン決済の性質上、トランザクションのリバート (巻き戻し) が難しいという指摘あり。 :contentReference[oaicite:19]{index=19}  
- インデクサー依存：支払い証明を正しく扱うには、ファシリテーターとインデクサーが信頼される必要がある。  
- 初期エコシステムの成熟度: 実装・相互運用性テストがまだ発展途上との報告あり。 :contentReference[oaicite:20]{index=20}  
- 競合 /代替プロトコル: h402 など、x402 のアイデアを拡張・改良しようとするプロジェクトも存在。 :contentReference[oaicite:21]{index=21}  

## 規格・標準化
- オープン標準として設計されており、誰でも実装または拡張可能。 :contentReference[oaicite:22]{index=22}  
- HTTP スタック (Web サーバー) に対する軽量な統合を重視しており、既存 Web インフラへの導入コストを抑えている。

## 開発者への提案 / 要件定義ポイント
- サービス提供者 (API プロバイダー) と支払い検証者 (ファシリテーター) のアーキテクチャを明確に設計する。  
- クライアント SDK (Node.js / ブラウザ) の導入を検討し、支払いリクエストの署名およびトランザクション処理を安全に実装。  
- 支払い失敗・再試行時のリトライロジック (HTTP 402 → 支払い → リクエスト再送) を含める。  
- 利用トークン (例: USDC, PING) を決定し、スマートコントラクト／ウォレットとの統合方法を定義。  
- セキュリティおよびガスコスト最適化を視野に入れ、ファシリテーターや検証機構の設計を行う。

---

